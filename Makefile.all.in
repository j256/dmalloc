###############################################################################
# Makefile for the DMalloc library.
# $Id: Makefile.all.in,v 1.45 1994/09/12 17:17:42 gray Exp $
###############################################################################

# default root installation directory
prefix = /usr/local

srcdir = @srcdir@
bindir = $(prefix)/bin
libdir = $(prefix)/lib
incdir = $(prefix)/include
infodir = $(prefix)/info

# default c-compiler
CC = @CC@

DEFS =
INCS = -I$(srcdir)
LIBS = @LIBS@

LIBRARY	= libdmalloc.a
UTIL = dmalloc
INFOFILE = dmalloc.info

CCFLAGS = -g
LDFLAGS = -g

INSTALL = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@

###############################################################################
# End of system configuration section.
###############################################################################

SHELL = /bin/sh

HFLS = dmalloc.h
OBJS = arg_check.o chunk.o compat.o error.o heap.o malloc.o dmalloc_lp.o
OBJS_IN = dmalloc_lp.o

CFLAGS = $(CCFLAGS)
TEST = dmalloc_t

# .PHONY : all
all : $(LIBRARY) $(UTIL)

# .PHONY : clean
clean :
	rm -f a.out core *.o *.t

# .PHONY : clobber
clobber : clean
	rm -f $(LIBRARY) $(TEST) $(UTIL) dmalloc.h

# .PHONY : realclean
realclean : clobber

# .PHONY : distclean
distclean : clobber
	rm -f config.status Makefile conf.h dmalloc.h.2
#	rm -f configure

# .PHONY : installincs
installincs : $(HFLS)
	$(INSTALL_DATA) $(HFLS) $(incdir)

# .PHONY : installlib
installlib : installincs $(LIBRARY) $(OBJS_IN) $(INFOFILE)
	$(INSTALL_DATA) $(LIBRARY) $(libdir)
	@RANLIB@ $(libdir)/$(LIBRARY)
	@ echo 'Please install $(OBJS_IN) and $(INFOFILE) by hand if needed.'
	$(INSTALL_DATA) $(OBJS_IN) $(libdir)
	$(INSTALL_DATA) $(INFOFILE) $(infodir)

# .PHONY : install
install : installlib $(UTIL)
	$(INSTALL_PROGRAM) $(UTIL) $(bindir)

dmalloc.h.2 : configure
	$(SHELL) configure

dmalloc.h : dmalloc.h.1 dmalloc.h.2 dmalloc.h.3
	rm -f $@ $@.t
	cat dmalloc.h.1 dmalloc.h.2 dmalloc.h.3 > $@.t
	mv $@.t $@

$(LIBRARY) : $(OBJS)
	ar cr $(LIBRARY) $?
	@RANLIB@ $@
	- chmod 660 $@

$(UTIL) : $(UTIL).o argv.o compat.o
	rm -f $@
	$(CC) $(LDFLAGS) $(UTIL).o argv.o compat.o $(LIBS)
	mv a.out $@

# .PHONY : noansi
noansi : dmalloc.h Deansify.pl
	perl ./Deansify.pl *.[ch]

# .PHONY : tests
tests : $(TEST)

$(TEST) : $(TEST).o argv.o $(LIBRARY)
	rm -f $@
	$(CC) $(LDFLAGS) $(TEST).o argv.o $(LIBS) $(LIBRARY)
	mv a.out $@

#.PHONY : check light
check light : $(TEST)
	./$(TEST) -s -t 10000
	./$(TEST) -s -t 10000
	./$(TEST) -s -t 10000
	./$(TEST) -s -t 10000
	./$(TEST) -s -t 10000

#.PHONY : heavy
heavy : $(TEST) light
	./$(TEST) -s -t 100000
	./$(TEST) -s -t 100000
	./$(TEST) -s -t 100000

# %.o : %.c
.c.o :
	rm -f $@
	$(CC) $(CFLAGS) $(CPPFLAGS) $(DEFS) $(INCS) -c $<

.texi.info :
	makeinfo $<

#
# auto configure settings
#
Makefile : Makefile.in
	$(SHELL) config.status

conf.h : conf.h.in
	$(SHELL) config.status

config.status : configure
	$(SHELL) config.status --recheck

configure : configure.in
	cd $(srcdir); autoconf

###############################################################################
#
# These dependencies are automatically generated.  Do not edit by hand.
#

arg_check.o : arg_check.c dmalloc.h conf.h chunk.h dmalloc_loc.h debug_val.h \
  error.h arg_check.h 
argv.o : argv.c argv.h argv_loc.h 
chunk.o : chunk.c dmalloc.h conf.h chunk.h dmalloc_loc.h chunk_loc.h compat.h \
  debug_val.h error.h error_val.h heap.h version.h 
compat.o : compat.c dmalloc.h conf.h compat.h dmalloc_loc.h 
dmalloc.o : dmalloc.c argv.h dmalloc.h conf.h compat.h dmalloc_loc.h debug_tok.h \
  debug_val.h error_str.h error_val.h version.h 
dmalloc_lp.o : dmalloc_lp.c dmalloc.h conf.h dmalloc_loc.h dmalloc_lp.h 
dmalloc_t.o : dmalloc_t.c argv.h dmalloc.h conf.h 
error.o : error.c dmalloc.h conf.h compat.h dmalloc_loc.h debug_val.h error.h 
heap.o : heap.c dmalloc.h conf.h chunk.h dmalloc_loc.h compat.h debug_val.h \
  error.h error_val.h heap.h 
malloc.o : malloc.c dmalloc.h conf.h chunk.h dmalloc_loc.h compat.h debug_val.h \
  error.h error_str.h error_val.h heap.h dmalloc_lp.h return.h 
