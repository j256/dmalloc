#
# $Id: Makefile.in,v 1.158 2003/05/16 19:20:06 gray Exp $
#

SHELL	= /bin/sh

# default root installation directory
prefix = @prefix@
exec_prefix = @exec_prefix@

srcdir = @srcdir@
VPATH = @srcdir@
shlibdir = @shlibdir@

CC = @CC@
CXX = @CXX@

HFLS	= dmalloc.h
OBJS	= arg_check.o compat.o dmalloc_tab.o env.o heap.o protect.o
NORMAL_OBJS = chunk.o error.o malloc.o
THREAD_OBJS = chunk_th.o error_th.o malloc_th.o
CXX_OBJS = dmallocc.o
VERSION	!= sed -e '/dmalloc_version/s/^.*\([0-9][0-9]*[.][0-9][0-9]*[.][0-9][0-9]*\(-b[0-9]\)*\).*$$/\1/p' -e d version.h

DEFS	= -DHAVE_STDARG_H=@HAVE_STDARG_H@ \
	-DHAVE_STDLIB_H=@HAVE_STDLIB_H@ \
	-DHAVE_STRING_H=@HAVE_STRING_H@ \
	-DHAVE_UNISTD_H=@HAVE_UNISTD_H@ \
	-DHAVE_SYS_MMAN_H=@HAVE_SYS_MMAN_H@ \
	-DHAVE_SYS_TYPES_H=@HAVE_SYS_TYPES_H@ \
	$(DEFINES)
INCS	= -I. -I$(srcdir) $(INCLUDES)
LIBS	= $(LIBRARIES)

MODULE	= dmalloc

LIBRARY	= lib$(MODULE).a

# thread version of the library
LIB_TH	= lib$(MODULE)th.a
SHLIB_TH = lib$(MODULE)th.so
@TH_ON@BUILD_TH = $(LIB_TH)
@TH_ON@INSTALL_TH = installth
@CXX_ON@@TH_ON@INSTALL_TH_CXX = installthcxx

# C++ version of the library
LIB_CXX	= lib$(MODULE)xx.a
SHLIB_CXX = lib$(MODULE)xx.so
@CXX_ON@BUILD_CXX = $(LIB_CXX)
@CXX_ON@INSTALL_CXX = installcxx
@CXX_ON@BUILD_TH_CXX = $(LIB_TH_CXX)

# shared versions of the library
LIB_SH = lib$(MODULE).so

# threads + C++
LIB_TH_CXX = lib$(MODULE)thcxx.a

CFLAGS	= -g $(CCFLS) -Wall -Wpointer-arith -Wshadow -Waggregate-return \
	-Wmissing-prototypes

LDFLAGS	= $(LLDFLAGS)
DESTDIR	= /usr/local
WWWDIR	= /var/httpd/root/dmalloc.com
TEST	= $(MODULE)_t
UTIL	= $(MODULE)
INFOFILE= $(MODULE).info

#
# WARNING: be careful about the order of this list some files are at
# the end on purpose
#
FLS	=  conf.h.in configure.in config.help \
	ChangeLog.1 Manifest INSTALL NEWS NOTES README RELEASE.html TODO \
	dmallocrc dmalloc.texi $(INFOFILE) dmalloc.html \
	arg_check.[ch] chunk.[ch] chunk_loc.h compat.[ch] debug_tok.h \
	env.[ch] error.[ch] error_val.h heap.[ch] \
	malloc.c dmalloc.c dmalloc.h.[13] dmalloc_loc.h \
	dmalloc_tab.[ch] dmalloc_tab_loc.h dmalloc_t.c malloc_funcs.h \
	protect.[ch] return.h version.h \
	settings.dist dmalloc_argv.[ch] dmalloc_argv_loc.h dmallocc.cc \
	install-sh mkinstalldirs dmalloc.spec \
	$(srcdir)/configure Makefile.bsd.ports
CONTFLS	= contrib/README contrib/Xmalloc.c contrib/aix_notes \
	contrib/atexit.c contrib/dec_notes contrib/dgux_notes \
	contrib/dmalloc.gdb contrib/dmalloc_summarize.pl contrib/next_notes \
	contrib/ra_info.pl contrib/stratus_ftx_notes

DOCS	= $(INFOFILE) dmalloc.html dmalloc.ps dmalloc.texi texinfo.tex

# Shar file maximum size
# NOTE: the wc level should be below 90k due to shar overhead
SHARSIZE= 85k

all :: dmalloc.h $(LIBRARY) $(UTIL) $(BUILD_CXX) $(BUILD_TH)
@CXX_OFF@	@echo "To make the C++ version of the library type 'make cxx'"
@TH_OFF@	@echo "To make the thread version of the library type 'make threads'"

clean ::
	$(CLEAN)
	rm -f $(LIBRARY) $(LIB_TH) $(LIB_CXX) $(LIB_TH_CXX) $(TEST)
	rm -f $(UTIL) dmalloc.h
	rm -f INSTALL README $(INFOFILE) dmalloc.html dmalloc_[0-9].html
	rm -f ChangeLog.1

distclean :: clean
	rm -f confdefs.h configure config.status config.log config.cache conf.h
	rm -f Makefile dmalloc.h.2 dmalloc.ps dmalloc.dvi settings.h
	rm -rf port

installincs :: $(HFLS)
	install -Cv -m 444 $(HFLS) $(DESTDIR)/include

installcxx :: $(LIB_CXX)
	install -Cv -m 644 $(LIB_CXX) $(DESTDIR)/lib

installthcxx :: $(LIB_THCXX)
	install -Cv -m 644 $(LIB_THCXX) $(DESTDIR)/lib

installth :: $(LIB_TH) $(INSTALL_TH_CXX)
	install -Cv -m 644 $(LIB_TH) $(DESTDIR)/lib
@CXX_OFF@	@echo "Enter 'make installthcxx' to install the C++ library"

installlibs :: installincs $(LIBRARY) $(INSTALL_CXX) $(INSTALL_TH)
	install -Cv -m 644 $(LIBRARY) $(DESTDIR)/lib
@CXX_OFF@	@echo "Enter 'make installcxx' to install the C++ library"
@TH_OFF@	@echo "Enter 'make installth' to install thread library"

installdocs :: $(DOCS)
	-mkdir $(WWWDIR)/docs/$(VERSION) $(WWWDIR)/docs/$(VERSION)/online
	-chmod 755 $(WWWDIR)/docs/$(VERSION) $(WWWDIR)/docs/$(VERSION)/online
	install -Cv -m 444 $(DOCS) $(WWWDIR)/docs/$(VERSION)
	-cd $(WWWDIR)/docs/$(VERSION)/online ;\
		umask 022 ;\
		texi2html -menu -number -split_node ../dmalloc.texi ;\
		for f in dmalloc*.html ; do \
			sed -e 's,</BODY>,<P><A HREF="http://dmalloc.com/">Dmalloc Home Page</A>.  Copyright 2001 by <A HREF="http://256.com/gray/">Gray Watson</A></BODY>,' $$f > $$f.t ;\
			mv $$f.t $$f ;\
		done
	cd $(WWWDIR)/docs/$(VERSION) ; for file in $(DOCS) ;\
		do gzip -9f $$file ; done

installshlib : $(SHLIBRARY)
	install -Cv -m 644 $(srcdir)/$(SHLIBRARY) $(shlibdir)

install :: installlibs $(UTIL) $(INFOFILE)
	install -Cv $(UTIL) $(DESTDIR)/bin
	install -Cv -m 444 $(INFOFILE) $(DESTDIR)/info

# put situation specific lines here
dmalloc.h.2 : config.status
	$(SHELL) config.status
	touch $@

settings.h : $(srcdir)/settings.dist config.status
	$(SHELL) config.status
	touch $@

dmalloc.h : $(srcdir)/dmalloc.h.1 dmalloc.h.2 $(srcdir)/dmalloc.h.3
	rm -f $@ $@.t
	cat $(srcdir)/dmalloc.h.1 dmalloc.h.2 $(srcdir)/dmalloc.h.3 > \
		$@.t
	mv $@.t $@

shlib : $(SHLIBRARY)

$(SHLIBRARY) : $(LIBRARY)
	rm -f $@ $@.t
	@shlinkargs@
	mv $@.t $@

$(LIBRARY) : $(OBJS) $(NORMAL_OBJS)
	ar cr $@ $?
	@RANLIB@ $@

$(LIB_TH) : $(OBJS) $(THREAD_OBJS)
	ar cr $@ $?
	@RANLIB@ $@

$(LIB_CXX) : $(OBJS) $(NORMAL_OBJS) $(CXX_OBJS)
	ar cr $@ $?
	@RANLIB@ $@

$(LIB_TH_CXX) : $(OBJS) $(THREAD_OBJS) $(CXX_OBJS)
	ar cr $@ $?
	@RANLIB@ $@

$(UTIL) : dmalloc.o dmalloc_argv.o compat.o env.o
	rm -f $@
	$(CC) $(LDFLAGS) $(UTIL).o dmalloc_argv.o compat.o env.o $(LIBS)
	mv a.out $@

threads : $(LIB_TH) $(BUILD_TH_CXX)

cxx : $(LIB_CXX)

# special _th versions of objects with the LOCK_THREADS variable defined to 1
chunk_th.o : chunk.c
	rm -f $@
	$(CC) $(CFLAGS) $(CPPFLAGS) $(DEFS) $(INCS) -DLOCK_THREADS=1 \
		-c $(srcdir)/chunk.c -o ./$@

error_th.o : error.c
	rm -f $@
	$(CC) $(CFLAGS) $(CPPFLAGS) $(DEFS) $(INCS) -DLOCK_THREAD=1 \
		-c $(srcdir)/error.c -o $@

malloc_th.o : malloc.c
	rm -f $@
	$(CC) $(CFLAGS) $(CPPFLAGS) $(DEFS) $(INCS) -DLOCK_THREAD=1 \
		-c $(srcdir)/malloc.c -o $@

tests :: $(TEST) compile_test

$(TEST) : $(TEST).o dmalloc_argv.o $(LIBRARY)
	rm -f $@
	$(CC) $(LDFLAGS) $(TEST).o dmalloc_argv.o $(LIBS) $(LIBRARY)
	mv a.out $@

check light :: $(TEST)
	$(TEST) -s -t 10000
	$(TEST) -s -t 10000
	$(TEST) -s -t 10000
	$(TEST) -s -t 10000
	$(TEST) -s -t 10000
	@echo light tests have passed

heavy :: $(TEST) light
	$(TEST) -s -t 100000
	$(TEST) -s -t 100000
	$(TEST) -s -t 100000
	@echo heavy tests have passed

continuous :: $(TEST)
	while $(TEST) -n -t 100000 ;\
		do  \
			echo '' ;\
		done

compile_test :: settings.h
	rm -f settings.h.t
	for setting in `grep -v '^#' settings.test | cut -f1 -d' ' ` ;\
	do \
		val=`grep "^$$setting " settings.test | cut -f2 -d' '` ;\
		echo "$$setting -> $$val" ;\
		perl -n -e "s/(#define[ \t]$$setting[ \t]+[^ \t]+$$)/#define $$setting $$val\n/; print;" \
			settings.dist > settings.h.t ;\
		mv settings.h.t settings.h ;\
		perl -n -e 'print "$$1$$_" if '"s/(#define[ \t]$$setting[ \t]+[^ \t]+$$)/#define $$setting $$val\n/;" \
			settings.dist ;\
		rm -f $(TEST) ;\
		echo "Making $(TEST)" ;\
		make $(TEST) > /dev/null ;\
		make light ;\
	done
	rm -f settings.h.t

port :: $(FLS) $(CONTFLS) Makefile.all.in
	@ test ! -d dmalloc-$(VERSION) || \
		answer 'Is it okay to remove the dmalloc-$(VERSION) dir? '
	rm -rf dmalloc-$(VERSION)
	mkdir dmalloc-$(VERSION) dmalloc-$(VERSION)/contrib
	cp $(FLS) Makefile.all.in dmalloc-$(VERSION)
	cp $(CONTFLS) dmalloc-$(VERSION)/contrib
	mv dmalloc-$(VERSION)/Makefile.all.in dmalloc-$(VERSION)/Makefile.in
	rm -f dmalloc-$(VERSION).tgz dmalloc-$(VERSION).tgz.t
	tar -czf dmalloc-$(VERSION).tgz.t dmalloc-$(VERSION)
	mv dmalloc-$(VERSION).tgz.t dmalloc-$(VERSION).tgz

ChangeLog.1 : ChangeLog
	rm -f $@ $@.t
	perl -n -e 's/[\w\.+-]+@[\w.+-]+//; print $$_;' < ChangeLog > $@.t
	mv $@.t $@

dmalloc.ps : $(srcdir)/dmalloc.texi
	rm -rf work
	mkdir work
	( cd work ; texi2dvi ../$(srcdir)/dmalloc.texi ;\
		dvips -o ../$@ dmalloc.dvi )
	rm -rf work

dmalloc.html : $(srcdir)/dmalloc.texi
	rm -f $@
	texi2html -number -monolithic $(srcdir)/dmalloc.texi

dmalloc.dvi : $(srcdir)/dmalloc.texi
	rm -rf work
	mkdir work
	( cd work ; texi2dvi ../$(srcdir)/dmalloc.texi ; mv dmalloc.dvi .. )
	rm -rf work

INSTALL : $(INFOFILE)
	rm -f $@ $@.t
	echo ------------------------------------------------------------------------------- \
		> $@.t
	sed -e '1,/,  Node: Installation/d' \
		-e '/,  Node: Getting Started/,$$d' \
		< $(INFOFILE) | tr -d '\037'  >> $@.t
	echo ------------------------------------------------------------------------------- \
		>> $@.t
	sed -e '1,/,  Node: Getting Started/d' \
		-e '/,  Node: Troubleshooting/,$$d' \
		< $(INFOFILE) | tr -d '\037'  >> $@.t
	echo ------------------------------------------------------------------------------- \
		>> $@.t
	sed -e '1,/,  Node: Troubleshooting/d' \
		-e '/,  Node: Programming/,$$d' \
		< $(INFOFILE) | tr -d '\037'  >> $@.t
	echo ------------------------------------------------------------------------------- \
		>> $@.t
	mv $@.t $@

README : $(srcdir)/README.1 $(INFOFILE)
	rm -f $@ $@.t
	echo ------------------------------------------------------------------------------- \
		> $@.t
	sed -e '1,/,  Node: Top/d' -e '/\* Menu:/,$$d' \
		< $(INFOFILE) | tr -d '\037'  >> $@.t
	cat $(srcdir)/README.1 >> $@.t
	mv $@.t $@

$(INFOFILE) : $(srcdir)/dmalloc.texi
	rm -f $@
	makeinfo --no-split $(.OODATE)

#
# auto configure settings
#
Makefile : $(srcdir)/Makefile.in config.status
	$(SHELL) config.status
	touch $@

conf.h : $(srcdir)/conf.h.in config.status
	$(SHELL) config.status
	touch $@

config.status : $(srcdir)/configure
	$(SHELL) config.status --recheck

$(srcdir)/configure : $(srcdir)/configure.in
	cd $(srcdir); autoconf

#
# Special .c dependency creation which handles the _th.o cases.
#
depend ::
	@ echo ""
	@ echo "WARNING: you should be running $(MAKE) depend2"
	@ false

depend2 ::
	rm -f $(DEPEND).t
	@ echo '#' > $(DEPEND).t
	@ echo '# This file contains dependencies that are automatically generated by make' >> $(DEPEND).t
	@ echo '# depend.  Please do not edit by hand.' >> $(DEPEND).t
	@ echo '#' >> $(DEPEND).t
	@ echo '' >> $(DEPEND).t
	- gcc $(INCS) -MM $(CFLS) >> $(DEPEND).t
	- gcc $(INCS) -MM chunk.c | sed -e 's/^chunk.o/chunk_th.o/' >> $(DEPEND).t
	- gcc $(INCS) -MM error.c | sed -e 's/^error.o/error_th.o/' >> $(DEPEND).t
	- gcc $(INCS) -MM malloc.c | sed -e 's/^malloc.o/malloc_th.o/' >> $(DEPEND).t
	rm -f $(DEPEND)
	mv $(DEPEND).t $(DEPEND)

.include <local.mk>
