#
# $Id: Makefile.in,v 1.15 1993/04/15 21:57:51 gray Exp $
#

HFLS	= malloc_dbg.h
OBJS	= chunk.o compat.o error.o heap.o malloc.o malloc_lp.o malloc_str.o
OBJS_IN	= malloc_lp.o 
FILLFLS	= chunk.c error.c heap.c malloc_dbg.c malloc_lp.c malloc_str.c \
	malloc_t.c sample.c

DEFS	= $(DEFINES)
INCS	= -I. $(INCLUDES)
LIBS	= -L. -lmalloc_dbg $(LIBRARIES)

PARTS	= 1 2 3 4 5
MAXPART	= 5

CFLAGS	= -g -W -Wreturn-type -Wunused -Wpointer-arith -Wshadow \
	-Wswitch -Wcomment -Wtrigraphs -Wformat -Wchar-subscripts \
	-Wuninitialized -Wparentheses -Waggregate-return
DESTDIR	= /usr/antaire
TESTS	= malloc_t
LIBRARY	= libmalloc_dbg.a
UTIL	= malloc_dbg

MANFILE	= malloc.info

PORTFILES=  conf.h.in Makefile.all.in configure configure.in \
	COPYING-LIB ChangeLog Manifest NOTES README TTD \
	chunk.[ch] chunk_loc.h compat.[ch] dbg_tokens.h dbg_values.h \
	error.[ch] error_str.h error_val.h heap.[ch] malloc.c mallocrc \
	malloc.info malloc.texi malloc_dbg.[ch] malloc_lp.[ch] malloc_loc.h \
	malloc_str.[ch] malloc_t.c sample.c version.h

.PHONY : all
all : $(LIBRARY) $(UTIL)

.PHONY : clobber
clobber :
	rm -f $(LIBRARY) $(TESTS) $(UTIL) part.? malloc.head malloc.info

.PHONY : distclean
distclean : clobber
	rm -f configure config.status Makefile conf.h
	rm -rf port

.PHONY : install
install : $(LIBRARY) $(OBJS_IN) $(UTIL) $(HFLS) $(MANFILE)
	install -ce -m 444 $(HFLS) $(DESTDIR)/inc
	install -ce $(UTIL) $(DESTDIR)/bin
	install -cer -m 644 $(LIBRARY) $(DESTDIR)/lib
	install -ce -m 444 $(OBJS_IN) $(DESTDIR)/lib
	install -ce -m 444 $(MANFILE) $(DESTDIR)/info

.PHONY : installincs
installincs : $(HFLS)
	install -ce -m 444 $(HFLS) $(DESTDIR)/inc

# put situation specific lines here
$(LIBRARY) : $(OBJS)
	ar cr $(LIBRARY) $?
	ranlib $@
	- chmod 660 $@

$(UTIL) : malloc_dbg.o $(LIBRARY) /usr/antaire/lib
	$(CC) $(LDFLAGS) $@.o $(LIBS)
	mv a.out $@

.PHONY : port
port : malloc.info
	@ answer 'Is it okay to remove the $@ directory? '
	rm -rf $@
	mkdir $@
	cp $(PORTFILES) $@
	mv $@/Makefile.all.in $@/Makefile.in
	@ echo ''
	@ echo 'Please rename $@ to malloc-version and tar up file'

.PHONY : localfill
localfill : $(FILLFLS)
	fillproto $(FILLFLS)

tests : $(TESTS)

malloc_t : malloc_t.o $(LIBRARY)

malloc.head : malloc.info
	rm -f $@ $@.t
	sed -e '/^Malloc Debug Library/,/^   Gray Watson/p' -e 'd' < \
		malloc.info > $@.t
	mv $@.t $@

.PHONY : shar
shar : malloc.info malloc.head
	rm -f part.? part.tmp
	$(foreach part, $(PARTS), \
		shar -b -n${part} -e${MAXPART} -opart.${part} -t \
			"Do a 'sh ./configure' to configure the library" \
			`cat shar.${part}` ; \
		)

	cat malloc.head > part.tmp
	echo '' >> part.tmp
	echo ---------------------------------------------------------------- \
		>> part.tmp
	cat part.1 >> part.tmp
	mv part.tmp part.1

include /usr/antaire/Default.make
include Makefile.dep
