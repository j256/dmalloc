#
# Copyright 1993 by the Antaire Corporation
#
# $Id: Makefile.in,v 1.61 1994/11/03 22:26:16 gray Exp $
#

HFLS	= dmalloc.h
OBJS	= arg_check.o chunk.o compat.o dmalloc_lp.o env.o error.o heap.o \
	malloc.o
FILLFLS	= arg_check.c chunk.c error.c heap.c dmalloc_t.c
DOCS	= dmalloc.texi dmalloc.info dmalloc.ps

DEFS	= $(DEFINES)
INCS	= -I. $(INCLUDES)
LIBS	= $(LIBRARIES)

CFLAGS	= -g $(CCFLS) -pipe -W -Wreturn-type -Wunused -Wpointer-arith \
	-Wshadow -Wswitch -Wcomment -Wtrigraphs -Wformat -Wchar-subscripts \
	-Wuninitialized -Wparentheses -Waggregate-return
LDFLAGS	= $(LLDFLAGS)
DESTDIR	= $(ROOT)
TEST	= dmalloc_t
LIBRARY	= libdmalloc.a
LIB_DIS	= libdmalloclp.a
UTIL	= dmalloc

MANFILE	= dmalloc.info

PORTFLS	=  conf.h.in Makefile.all.in configure configure.in config.help \
	ChangeLog Manifest INSTALL NEWS NOTES README TODO dmallocrc \
	arg_check.[ch] chunk.[ch] chunk_loc.h compat.[ch] debug_tok.h \
	debug_val.h env.[ch] error.[ch] error_str.h error_val.h heap.[ch] \
	malloc.c dmalloc.c dmalloc.h.[13] dmalloc_loc.h dmalloc_lp.[ch] \
	dmalloc_t.c return.h version.h \
	argv.[ch] argv_loc.h \
	dmalloc.texi dmalloc.info dmalloc.ps texinfo.tex \
	install.sh mkinstalldirs Deansify.pl
PORTCFG	= contrib/README contrib/atexit.c contrib/dec_notes contrib/ra_info.pl

MAXSIZE	= 85k
# NOTE: the wc level should be below 90k due to shar overhead
SHARFLS	= conf.h.in Makefile.in configure configure.in config.help \
	ChangeLog Manifest INSTALL NEWS NOTES README TODO dmallocrc \
	arg_check.[ch] chunk.[ch] chunk_loc.h compat.[ch] debug_tok.h \
	debug_val.h error.[ch] error_str.h error_val.h heap.[ch] malloc.c \
	dmalloc.c dmalloc.h.[13] dmalloc_loc.h dmalloc_lp.[ch] dmalloc_t.c \
	return.h version.h \
	argv.[ch] argv_loc.h \
	dmalloc.texi dmalloc.info \
	Deansify.pl \
	contrib contrib/README contrib/dec_notes \
	contrib/ra_info.pl

.PHONY : all
all : $(LIBRARY) $(LIB_DIS) $(UTIL)

.PHONY : clobber
clobber :
	rm -f $(LIBRARY) $(LIB_DIS) $(TEST) $(UTIL)
	rm -f part.? dmalloc.head dmalloc.info dmalloc.h

.PHONY : distclean
distclean : clobber
	rm -f configure config.status Makefile conf.h dmalloc.h.2
	rm -rf port dmalloc.ps

.PHONY : installincs
installincs : $(HFLS)
	install -cev -m 444 $(HFLS) $(DESTDIR)/inc

.PHONY : installlibs
installlibs : installincs $(LIBRARY) $(LIB_DIS) $(MANFILE)
	install -cevr -m 644 $(LIBRARY) $(DESTDIR)/lib
	install -cevr -m 644 $(LIB_DIS) $(DESTDIR)/lib
	install -cev -m 444 $(OBJS_INST) $(DESTDIR)/lib
	install -cev -m 444 $(MANFILE) $(DESTDIR)/info

.PHONY : install
install : installlibs $(UTIL)
	install -cev $(UTIL) $(DESTDIR)/bin

.PHONY : installftp
installftp : README_ftp $(DOCS)
	install -cev -o ftp -g ftp -m 444 README_ftp ftp/README
	install -cev -o ftp -g ftp -m 444 $(DOCS) ftp/docs

# put situation specific lines here
dmalloc.h.2 : configure
	$(SHELL) configure -v

dmalloc.h : dmalloc.h.1 dmalloc.h.2 dmalloc.h.3
	rm -f $@ $@.t
	cat dmalloc.h.1 dmalloc.h.2 dmalloc.h.3 > $@.t
	mv $@.t $@

$(LIBRARY) : $(OBJS)
	ar cr $(LIBRARY) $?
	ranlib $@

$(LIB_DIS) : dmalloc_lp.o
	ar cr $(LIB_DIS) $?
	ranlib $@

$(UTIL) : dmalloc.o argv.o compat.o env.o
	rm -f $@
	$(CC) $(LDFLAGS) $(UTIL).o argv.o compat.o env.o $(LIBS)
	mv a.out $@

.PHONY : port
port : $(PORTFLS)
	@ answer 'Is it okay to remove the $@ directory? '
	rm -rf $@
	mkdir $@ $@/contrib
	cp $(PORTFLS) $@
	cp $(PORTCFG) $@/contrib
	mv $@/Makefile.all.in $@/Makefile.in
	@ echo ''
	@ echo 'Please rename $@ to dmalloc-version and tar up file'

.PHONY : patch
patch :
	@ echo 'Run fixpatch.pl on the patch file'

.PHONY : fill
fill : $(FILLFLS)
	fillproto $(FILLFLS)

tests : $(TEST)

$(TEST) : $(TEST).o argv.o $(LIBRARY)
	rm -f $@
	$(CC) $(LDFLAGS) $(TEST).o argv.o $(LIBS) $(LIBRARY)
	mv a.out $@

.PHONY : light
light : $(TEST)
	$(TEST) -s -t 10000
	$(TEST) -s -t 10000
	$(TEST) -s -t 10000
	$(TEST) -s -t 10000
	$(TEST) -s -t 10000

.PHONY : heavy
heavy : $(TEST) light
	$(TEST) -s -t 100000
	$(TEST) -s -t 100000
	$(TEST) -s -t 100000

.PHONY : continuous
continuous : $(TEST)
	while test 1 ;\
		do  (\
			$(TEST) -n -t 10000 ;\
			sleep 1 ;\
		); done

dmalloc.ps : dmalloc.texi
	@ answer 'Is it okay to remove the work directory? '
	rm -rf work
	mkdir work
	( cd work ; texi2dvi ../dmalloc.texi ; texi2dvi ../dmalloc.texi ; \
	  dvips -o ../$@ dmalloc.dvi )
	rm -rf work

dmalloc.head : dmalloc.info
	rm -f $@ $@.t
	sed -e '/^Debug Malloc Library/,/Gray Watson/p' -e 'd' < \
		dmalloc.info > $@.t
	echo '' >> $@.t
	echo ---------------------------------------------------------------- \
		>> $@.t
	mv $@.t $@

dmalloc.info : dmalloc.texi
	rm -f $@
	makeinfo --no-split $^

.PHONY : shar
shar : dmalloc.head
	rm -f part.?? part.t Makefile.in.bak
	mv Makefile.in Makefile.in.bak
	cp Makefile.all.in Makefile.in
	makekit -n part. -s${MAXSIZE} -t \
		"Do a 'sh ./configure' to configure the library" \
		${SHARFLS}
	rm -f Makefile.in
	mv Makefile.in.bak Makefile.in
	cat dmalloc.head part.01 > part.t
	rm -f part.01
	mv part.t part.01

#
# auto configure settings
#
Makefile : Makefile.in
	$(SHELL) config.status

conf.h : conf.h.in
	$(SHELL) config.status

config.status : configure
	$(SHELL) config.status --recheck

configure : configure.in
	autoconf

include /usr/antaire/Default.make
include Makefile.dep
